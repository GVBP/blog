var mongoose = require('mongoose');
var express = require('express');
var router = express.Router();

// Carrega/Executa trazendo apenas o retorno da function
var Person = require('./../model/person')();
var Story = require('./../model/story')();


/* GET posts page */
// next referece a pr√≥xima middleware
router.get('/', function (req, res, next) {

    Person
        .findOne({ name: 'Ian Fleming' })
        .populate('stories')
        .exec(function (err, person) {
            if (err) return handleError(err);
            console.log('Person', person);

            Story
                .find({ author: person._id })
                .exec(function (err, stories) {
                    if (err) return handleError(err);
                    console.log('The stories are an array: ', stories);
                });

            // res.json(person);
            res.render('posts', { title: 'Postagens', teste : person });
        });

    // Story.findOne({ title: /Casino Royale/i })
    //     .select('title author _id')
    //     .populate('author', 'name age -_id')
    //     .populate('fans')
    //     .exec(function (err, story) {
    //         if (err) return handleError(err);
    //         console.log('The author is %s', story);
    //         // prints "The author is Ian Fleming"

    //     });


});

router.patch('/update', function (req, res, next) {

    Person
        .findOne({ name: 'Ian Fleming' })
        .populate('stories')
        .exec(function (err, person) {
            if (err) return handleError(err);
            console.log('Person', person);

            var newStory = Story({
                title: 'Salvando outro 12',
                author: person._id
            });

            // person.stories.push(newStory);
            person.stories = person.stories.concat([newStory]);


            console.log('Person stories', person.stories);

            person.save(function (err) {
                if (err) throw err;
                console.log('save person', person);

            });

            newStory.save(function (err) {
                if (err) throw err;
                console.log('save story', newStory);
            });


        });

    res.redirect('/posts');
});



router.post('/new/user', function (req, res, next) {

    var author = new Person({
        _id: new mongoose.Types.ObjectId(),
        name: 'Ian Fleming',
        age: 50
    });

    var story1 = new Story({
        title: 'Casino Royale',
        author: author._id
    });

    author.stories.push(story1);


    author.save(function (err) {
        if (err) return handleError(err);

        console.log('Antes da Story', author._id);
        // var story1 = Story({
        //     title: 'Casino Royale',
        //     author: author._id 
        // });

        // story1.save(function (err) {
        //     if (err) return handleError(err);
        //     // thats it!
        // });

        console.log('vardepois', author);
    });

    story1.save(function (err) {
        if (err) return handleError(err);
        // thats it!
    });

    res.redirect('/posts');
});

module.exports = router;